<!DOCTYPE html>
<html>
<head>
    <title>ROS2 Telemetry</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: #1a1a2e; 
            color: #eee; 
            padding: 20px;
            margin: 0;
        }
        h1 { color: #00d4ff; margin-bottom: 5px; }
        .status { 
            padding: 8px 15px; 
            border-radius: 20px; 
            display: inline-block;
            margin-bottom: 20px;
        }
        .connected { background: #00c853; color: #000; }
        .disconnected { background: #ff5252; }
        .card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .card h2 { margin-top: 0; color: #00d4ff; font-size: 18px; }
        .value {
            font-size: 28px;
            font-weight: bold;
            font-family: monospace;
        }
        .label { color: #888; font-size: 14px; }
        .grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .axis { text-align: center; }
        .x { color: #ff6b6b; }
        .y { color: #51cf66; }
        .z { color: #339af0; }
        .video-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
            margin-bottom: 15px;
        }
        .video-card {
            background: #16213e;
            border-radius: 10px;
            overflow: hidden;
        }
        .video-card h3 {
            margin: 0;
            padding: 10px;
            background: #0f3460;
            color: #00d4ff;
            font-size: 14px;
        }
        .video-card img {
            width: 100%;
            display: block;
        }
        .sensor-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        .lidar-card {
            background: #16213e;
            border-radius: 10px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        .lidar-card h2 { margin-top: 0; color: #00d4ff; font-size: 18px; }
        #lidar-canvas { background: #0d1b2a; border-radius: 6px; }
    </style>
</head>
<body>
    <h1>ROS2 Robot Telemetry</h1>
    <div id=status class=status disconnected>Disconnected</div>
    
    <div class=video-container>
        <div class=video-card>
            <h3>Left Camera</h3>
            <img id=left-cam src="" alt="Left Camera">
        </div>
        <div class=video-card>
            <h3>Right Camera</h3>
            <img id=right-cam src="" alt="Right Camera">
        </div>
    </div>
    
    <div class=lidar-card>
        <h2>LiDAR range map</h2>
        <canvas id=lidar-canvas width=400 height=400></canvas>
        <div class=label id=lidar-status>Waiting for /scan...</div>
    </div>
    
    <div class=sensor-row>
        <div class=card>
            <h2>Linear Acceleration (m/s2)</h2>
            <div class=grid>
                <div class=axis><div class=label>X</div><div class=value x id=ax>--</div></div>
                <div class=axis><div class=label>Y</div><div class=value y id=ay>--</div></div>
                <div class=axis><div class=label>Z</div><div class=value z id=az>--</div></div>
            </div>
        </div>
        <div class=card>
            <h2>Angular Velocity (rad/s)</h2>
            <div class=grid>
                <div class=axis><div class=label>X</div><div class=value x id=gx>--</div></div>
                <div class=axis><div class=label>Y</div><div class=value y id=gy>--</div></div>
                <div class=axis><div class=label>Z</div><div class=value z id=gz>--</div></div>
            </div>
        </div>
    </div>

    <script>
        const host = location.hostname;
        document.getElementById('left-cam').src = 'http://' + host + ':8081/left';
        document.getElementById('right-cam').src = 'http://' + host + ':8081/right';

        const ws = new WebSocket('ws://' + host + ':9090');
        const status = document.getElementById('status');
        const lidarStatus = document.getElementById('lidar-status');

        const canvas = document.getElementById('lidar-canvas');
        const ctx = canvas.getContext('2d');
        const lidarCx = canvas.width / 2;
        const lidarCy = canvas.height / 2;
        const lidarScale = Math.min(lidarCx, lidarCy) / 12; // 12 m max range default

        function drawLidar(msg) {
            const ranges = msg.ranges || msg.ranges_0 || [];
            const angleMin = msg.angle_min != null ? msg.angle_min : -Math.PI;
            const angleInc = msg.angle_increment != null ? msg.angle_increment : (2 * Math.PI / Math.max(1, ranges.length));
            const rangeMin = msg.range_min != null ? msg.range_min : 0;
            const rangeMax = msg.range_max != null ? msg.range_max : 12;

            ctx.fillStyle = '#0d1b2a';
            ctx.fillRect(0, 0, canvas.width, canvas.height);

            ctx.strokeStyle = 'rgba(0, 212, 255, 0.3)';
            ctx.lineWidth = 1;
            for (let r = 2; r <= 12; r += 2) {
                ctx.beginPath();
                ctx.arc(lidarCx, lidarCy, r * lidarScale, 0, 2 * Math.PI);
                ctx.stroke();
            }

            ctx.fillStyle = '#00d4ff';
            for (let i = 0; i < ranges.length; i++) {
                const range = Number(ranges[i]);
                if (range < rangeMin || range > rangeMax || !Number.isFinite(range)) continue;
                const angle = angleMin + i * angleInc;
                const x = lidarCx + range * Math.cos(angle) * lidarScale;
                const y = lidarCy - range * Math.sin(angle) * lidarScale;
                ctx.fillRect(x - 1, y - 1, 2, 2);
            }

            ctx.fillStyle = '#ff6b6b';
            ctx.beginPath();
            ctx.arc(lidarCx, lidarCy, 4, 0, 2 * Math.PI);
            ctx.fill();
        }

        ws.onopen = () => {
            status.textContent = 'Connected';
            status.className = 'status connected';
            ws.send(JSON.stringify({ op: 'subscribe', topic: '/imu/data_raw' }));
            ws.send(JSON.stringify({ op: 'subscribe', topic: '/scan' }));
        };

        ws.onclose = () => {
            status.textContent = 'Disconnected';
            status.className = 'status disconnected';
        };

        ws.onmessage = (event) => {
            let data;
            try {
                data = JSON.parse(event.data);
            } catch (e) {
                console.warn('WebSocket parse error:', e);
                return;
            }
            if (data.op === 'publish' && data.msg) {
                const msg = data.msg;
                const isScan = data.topic === '/scan' || (msg.ranges && msg.angle_min != null);
                if (isScan) {
                    lidarStatus.textContent = '/scan â€“ ' + (msg.ranges || msg.ranges_0 || []).length + ' points';
                    drawLidar(msg);
                } else {
                    // IMU: update both accel and gyro when present (same message can have both)
                    if (msg.linear_acceleration != null) {
                        document.getElementById('ax').textContent = Number(msg.linear_acceleration.x).toFixed(2);
                        document.getElementById('ay').textContent = Number(msg.linear_acceleration.y).toFixed(2);
                        document.getElementById('az').textContent = Number(msg.linear_acceleration.z).toFixed(2);
                    }
                    if (msg.angular_velocity != null) {
                        document.getElementById('gx').textContent = Number(msg.angular_velocity.x).toFixed(3);
                        document.getElementById('gy').textContent = Number(msg.angular_velocity.y).toFixed(3);
                        document.getElementById('gz').textContent = Number(msg.angular_velocity.z).toFixed(3);
                    }
                }
            }
        };
    </script>
</body>
</html>
